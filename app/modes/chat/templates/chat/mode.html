{% extends "base.html" %}

{% block title %}Chat Mode - {{ topic_name }}{% endblock %}

{% block styles %}
<!-- Marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
    #chat-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        height: 85vh;
        display: flex;
        flex-direction: column;
    }

    #chat-container h1 {
        margin-bottom: 20px;
        font-size: 1.8em;
    }

    #chat-window {
        flex-grow: 1;
        overflow-y: auto;
        margin-bottom: 30px;
        padding: 15px;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
    }

    .message {
        padding: 12px 16px;
        border-radius: 16px;
        max-width: 80%;
        line-height: 1.6;
        word-wrap: break-word;
    }

    .message p {
        margin: 0 0 10px 0;
    }

    .message p:last-child {
        margin-bottom: 0;
    }

    .message ul,
    .message ol {
        margin: 10px 0;
        padding-left: 20px;
    }

    .message li {
        margin-bottom: 5px;
    }

    .message code {
        background-color: rgba(0, 0, 0, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.9em;
    }

    .message pre {
        background-color: rgba(0, 0, 0, 0.1);
        padding: 12px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 10px 0;
    }

    .message pre code {
        background: none;
        padding: 0;
    }

    .user-message {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
    }

    .assistant-message {
        background-color: #ffffff;
        color: #333;
        align-self: flex-start;
        border: 1px solid #e0e0e0;
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    #chat-form {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    #chat-input {
        flex-grow: 1;
        padding: 16px 24px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 1rem;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        outline: none;
    }

    #chat-input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
    }

    #chat-input::placeholder {
        color: #999;
    }

    /* Dark Mode Styles */
    body.dark-mode #chat-window {
        background-color: #3a3a3a;
        border-color: #555;
    }

    body.dark-mode .assistant-message {
        background-color: #4a4a4a;
        color: #e0e0e0;
        border-color: #555;
    }

    body.dark-mode .assistant-message code {
        background-color: rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .assistant-message pre {
        background-color: rgba(0, 0, 0, 0.3);
    }

    body.dark-mode .user-message {
        background: linear-gradient(135deg, #697565 0%, #5a6555 100%);
    }

    body.dark-mode .user-message code {
        background-color: rgba(255, 255, 255, 0.15);
    }

    body.dark-mode #chat-input {
        background-color: #3a3a3a;
        color: #e0e0e0;
        border-color: #555;
    }

    body.dark-mode #chat-input:focus {
        border-color: #697565;
        box-shadow: 0 0 0 3px rgba(105, 117, 101, 0.3);
    }

    body.dark-mode #chat-input::placeholder {
        color: #888;
    }
</style>
{% endblock %}

{% block content %}
<div id="chat-container">
    <h1>Chat with your AI Tutor about {{ topic_name }}</h1>
    <div id="chat-window">
        {% for message in chat_history %}
        <div class="message {{ 'user-message' if message.role == 'user' else 'assistant-message' }}">
            <div class="message-content">{{ message.content }}</div>
        </div>
        {% endfor %}
    </div>
    <form id="chat-form" method="POST" action="{{ url_for('chat.send_message', topic_name=topic_name) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="text" id="chat-input" name="message" placeholder="Ask a question..." autocomplete="off" autofocus>
        <button class="button" type="submit">Send</button>
    </form>
</div>

<script>
    // Render markdown for assistant messages
    document.addEventListener('DOMContentLoaded', function () {
        const assistantMessages = document.querySelectorAll('.assistant-message .message-content');
        assistantMessages.forEach(function (el) {
            const rawContent = el.textContent;
            el.innerHTML = marked.parse(rawContent);
        });

        // Auto-scroll to bottom of chat
        const chatWindow = document.getElementById('chat-window');
        chatWindow.scrollTop = chatWindow.scrollHeight;
    });
</script>
{% endblock %}