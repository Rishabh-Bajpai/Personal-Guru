{% extends "base.html" %}

{% block title %}Learning {{ topic.name }} - Step {{ step_index + 1 }}{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/12.2.0/markdown-it.min.js"></script>
{% endblock %}

{% block content %}
<div class="main-layout">
    <div class="plan-panel">
        <h2>Study Plan</h2>
        <ul>
            {% for step in topic.plan %}
            <li
                class="{{ 'active' if loop.index0 == step_index else '' }} {{ 'future-step' if loop.index0 > step_index else '' }}">
                {% if loop.index0 <= step_index %} <a
                    href="{{ url_for('chapter.learn_topic', topic_name=topic.name, step_index=loop.index0) }}"
                    onclick="showLoader()">{{ step }}</a>
                    {% else %}
                    {{ step }}
                    {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="container">
        <h1>Learning: {{ topic.name }}</h1>
        <h2>Step {{ step_index + 1 }} of {{ total_steps }}</h2>

        <div class="study-plan">
            <h2>{{ step_title }}</h2>
            <div id="step-content-rendered"></div>
            <div id="step-content-markdown" style="display: none;">{{ step_content }}</div>
        </div>

        <div class="audio-controls">
            <label for="read-aloud-switch" class="switch-label">Read Aloud</label>
            <label class="switch">
                <input type="checkbox" id="read-aloud-switch">
                <span class="slider round"></span>
            </label>
            <button id="read-button" class="button">Read</button>
        </div>

        <audio id="audio-player">
            <source src="" type="audio/wav">
            Your browser does not support the audio element.
        </audio>

        <div class="chat-container">
            <h3>Ask a Question</h3>
            <div id="chat-history"></div>
            <form id="chat-form">
                <input type="text" id="chat-input" placeholder="Type your question here...">
                <button type="submit" class="button">Send</button>
            </form>
        </div>

        {% if question_data and question_data.questions %}
        <div class="assessment">
            <h3>Check Your Understanding</h3>
            {% if show_assessment %}
            <form action="{{ url_for('chapter.assess_step', topic_name=topic.name, step_index=step_index) }}"
                method="post" onsubmit="showLoader()">
                {% for question in question_data.questions %}
                <div class="question">
                    <p>{{ loop.index }}. {{ question.question }}</p>
                    {% set outer_loop_index = loop.index0 %}
                    {% for option in question.options %}
                    <div class="option">
                        <label for="option_{{ outer_loop_index }}_{{ loop.index0 }}">
                            <input type="radio" id="option_{{ outer_loop_index }}_{{ loop.index0 }}"
                                name="option_{{ outer_loop_index }}" value="{{ ['A', 'B', 'C', 'D'][loop.index0] }}">
                            {{ ['A', 'B', 'C', 'D'][loop.index0] }}) {{ option }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
                <button type="submit" class="button">Submit Answers</button>
            </form>
            {% else %}
            {% for question in question_data.questions %}
            <div class="question">
                <p>{{ loop.index }}. {{ question.question }}</p>
                {% set outer_loop_index = loop.index0 %}
                {% for option in question.options %}
                <div class="option">
                    <label for="option_{{ outer_loop_index }}_{{ loop.index0 }}">
                        <input type="radio" id="option_{{ outer_loop_index }}_{{ loop.index0 }}"
                            name="option_{{ outer_loop_index }}" value="{{ ['A', 'B', 'C', 'D'][loop.index0] }}"
                            disabled {% if topic.steps[step_index].user_answers and
                            topic.steps[step_index].user_answers[outer_loop_index]==['A', 'B' , 'C' , 'D' ][loop.index0]
                            %}checked{% endif %}>
                        {{ ['A', 'B', 'C', 'D'][loop.index0] }}) {{ option }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
            {% endif %}
        </div>
        {% endif %}

        <div class="navigation">
            {% if step_index < total_steps - 1 %} <a
                href="{{ url_for('chapter.learn_topic', topic_name=topic.name, step_index=step_index + 1) }}"
                class="button" onclick="showLoader()">Next Step</a>
                {% else %}
                <a href="{{ url_for('chapter.complete_topic', topic_name=topic.name) }}" class="button"
                    onclick="showLoader()">Finish Course</a>
                {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const md = window.markdownit();
    const markdownContent = document.getElementById('step-content-markdown').textContent;
    const renderedContent = document.getElementById('step-content-rendered');
    renderedContent.innerHTML = md.render(markdownContent);

    const readAloudSwitch = document.getElementById('read-aloud-switch');
    const readButton = document.getElementById('read-button');
    const audioPlayer = document.getElementById('audio-player');

    async function generateAndPlayAudio() {
        showLoader();
        try {
            const response = await fetch("{{ url_for('chapter.generate_audio_route', step_index=step_index) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ text: markdownContent })
            });
            const data = await response.json();
            if (data.audio_url) {
                audioPlayer.src = data.audio_url;
                audioPlayer.play();
            }
        } finally {
            hideLoader();
        }
    }

    if (sessionStorage.getItem('readAloud') === 'true') {
        readAloudSwitch.checked = true;
        generateAndPlayAudio();
    }

    readAloudSwitch.addEventListener('change', function () {
        sessionStorage.setItem('readAloud', this.checked);
        if (this.checked) {
            generateAndPlayAudio();
        } else {
            audioPlayer.pause();
        }
    });

    readButton.addEventListener('click', generateAndPlayAudio);

    document.getElementById('chat-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        const question = input.value;
        input.value = '';

        const chatHistory = document.getElementById('chat-history');
        const userMessage = document.createElement('p');
        userMessage.textContent = `You: ${question}`;
        chatHistory.appendChild(userMessage);

        showLoader();
        try {
            const response = await fetch("{{ url_for('chat.chat', topic_name=topic.name, step_index=step_index) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ question: question })
            });


            const data = await response.json();
            const botMessage = document.createElement('p');
            botMessage.textContent = `Bot: ${data.answer}`;
            chatHistory.appendChild(botMessage);
        } finally {
            hideLoader();
        }
    });
</script>
{% endblock %}