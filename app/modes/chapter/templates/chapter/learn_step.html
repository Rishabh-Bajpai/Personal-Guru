{% extends "base.html" %}

{% block title %}Learning {{ topic.name }} - Step {{ step_index + 1 }}{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/12.2.0/markdown-it.min.js"></script>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('chapter.static', filename='chapter.css') }}">
<link rel="stylesheet" href="{{ url_for('common.static', filename='css/chat_popup.css') }}">
{% endblock %}

{% block content %}
<div class="main-layout" style="display: flex; gap: 20px; height: 90vh;">
    <!-- Unified Plan Sidebar -->
    <div id="plan-sidebar">
        <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle Sidebar">
            â˜°
        </button>
        <div class="sidebar-content">
            <h2>Study Plan</h2>
            <ul id="plan-steps">
                {% for step in topic.plan %}
                <li
                    class="{{ 'active' if loop.index0 == step_index else '' }} {{ 'future-step' if loop.index0 > step_index else '' }}">
                    <a href="{{ url_for('chapter.learn_topic', topic_name=topic.name, step_index=loop.index0) }}"
                        onclick="showLoader()" style="color: inherit; text-decoration: none; display: block;">{{ step
                        }}</a>
                </li>
                {% endfor %}
            </ul>
            <form id="plan-modification-form" method="POST"
                action="{{ url_for('chapter.update_plan', topic_name=topic.name) }}">
                <h3>Modify the Plan</h3>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <!-- Pass current step index to return to it -->
                <input type="hidden" name="current_step_index" value="{{ step_index }}">
                <textarea id="plan-modification-input" name="comment" maxlength="255"
                    placeholder="Suggest changes to the plan..."></textarea>
                <button id="plan-modification-button" type="submit" class="button is-small">Update Plan</button>
            </form>
        </div>
    </div>

    <div class="learning-content" style="flex-grow: 1; overflow-y: auto; padding-right: 20px;">
        <div class="podcast-section" style="margin-bottom: 20px;">
            <div class="podcast-header">
                <h3>AI Podcast</h3>
                {% if topic.chapter_mode[step_index].podcast_audio_content %}
                <button id="generate-podcast-btn" class="generate-podcast-btn" style="display: none;">
                    <span>Generate Podcast</span>
                </button>
                {% else %}
                <button id="generate-podcast-btn" class="generate-podcast-btn">
                    <span>Generate Podcast</span>
                </button>
                {% endif %}
            </div>

            {% if topic.chapter_mode[step_index].podcast_audio_content %}
            <div id="podcast-player-container" class="podcast-player" style="display: flex;">
                {% else %}
                <div id="podcast-player-container" class="podcast-player" style="display: none;">
                    {% endif %}
                    <button id="podcast-play-btn" class="podcast-control-btn">
                        <svg viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z" />
                        </svg>
                    </button>
                    <div class="podcast-progress-container">
                        <span id="podcast-current-time" class="podcast-time">0:00</span>
                        <div id="podcast-progress-bar" class="podcast-progress-bar">
                            <div id="podcast-progress-fill" class="podcast-progress-fill"></div>
                        </div>
                        <span id="podcast-duration" class="podcast-time">0:00</span>
                    </div>
                    {% if topic.chapter_mode[step_index].podcast_audio_content %}
                    <audio id="podcast-audio" style="display: none;"
                        src="data:audio/mp3;base64,{{ topic.chapter_mode[step_index].podcast_audio_content }}"></audio>
                    {% else %}
                    <audio id="podcast-audio" style="display: none;"></audio>
                    {% endif %}
                </div>
            </div>

            <h1>Learning: {{ topic.name }}</h1>
            <h2>Step {{ step_index + 1 }} of {{ total_steps }}</h2>

            <div class="study-plan">
                <h2>{{ step_title }}</h2>
                <div id="step-content-rendered"></div>
                <div id="step-content-markdown" style="display: none;">{{ step_content }}</div>
            </div>

            <div class="audio-controls">
                <label for="read-aloud-switch" class="switch-label">Read Aloud</label>
                <label class="switch">
                    <input type="checkbox" id="read-aloud-switch">
                    <span class="slider round"></span>
                </label>
                <button id="read-button" class="button">Read</button>
            </div>



            <audio id="audio-player">
                <source src="" type="audio/wav">
                Your browser does not support the audio element.
            </audio>

            {% if question_data and question_data.questions %}
            <div class="assessment">
                <h3>Check Your Understanding</h3>
                {% if show_assessment %}
                <form action="{{ url_for('chapter.assess_step', topic_name=topic.name, step_index=step_index) }}"
                    method="post" onsubmit="showLoader()">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    {% for question in question_data.questions %}
                    <div class="question">
                        <p>{{ loop.index }}. {{ question.question }}</p>
                        {% set outer_loop_index = loop.index0 %}
                        {% for option in question.options %}
                        <div class="option">
                            <label for="option_{{ outer_loop_index }}_{{ loop.index0 }}">
                                <input type="radio" id="option_{{ outer_loop_index }}_{{ loop.index0 }}"
                                    name="option_{{ outer_loop_index }}" value="{{ ['A', 'B', 'C', 'D'][loop.index0] }}"
                                    required>
                                {{ ['A', 'B', 'C', 'D'][loop.index0] }}) {{ option }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                    <button type="submit" class="button">Submit Answers</button>
                </form>
                {% else %}

                <div class="quiz-results">
                    {% if topic.chapter_mode[step_index].score is defined %}
                    <h4>Your Results (Score: {{ topic.chapter_mode[step_index].score|round|int }}%)</h4>
                    {% endif %}

                    {% for question in question_data.questions %}
                    <div class="question">
                        <p>{{ loop.index }}. {{ question.question }}</p>

                        {% if topic.chapter_mode[step_index].feedback and
                        topic.chapter_mode[step_index].feedback[loop.index0] %}
                        <div
                            class="feedback-item {{ 'correct' if topic.chapter_mode[step_index].feedback[loop.index0].is_correct else 'incorrect' }}">
                            <strong>{{ 'Correct!' if topic.chapter_mode[step_index].feedback[loop.index0].is_correct
                                else
                                'Incorrect.' }}</strong>
                            {{ topic.chapter_mode[step_index].feedback[loop.index0].explanation }}
                        </div>
                        {% endif %}

                        {% set outer_loop_index = loop.index0 %}
                        {% for option in question.options %}
                        <div class="option">
                            <label for="option_{{ outer_loop_index }}_{{ loop.index0 }}">
                                <input type="radio" id="option_{{ outer_loop_index }}_{{ loop.index0 }}"
                                    name="option_{{ outer_loop_index }}" value="{{ ['A', 'B', 'C', 'D'][loop.index0] }}"
                                    disabled {% if topic.chapter_mode[step_index].user_answers and
                                    topic.chapter_mode[step_index].user_answers[outer_loop_index]==['A', 'B' , 'C' , 'D'
                                    ][loop.index0] %}checked{% endif %}>
                                {{ ['A', 'B', 'C', 'D'][loop.index0] }}) {{ option }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}

                    <form action="{{ url_for('chapter.reset_quiz', topic_name=topic.name, step_index=step_index) }}"
                        method="post" style="margin-top: 20px;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <button type="submit" class="button secondary">Retry Quiz</button>
                    </form>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <div class="navigation">
                {% if step_index > 0 %}
                <a href="{{ url_for('chapter.learn_topic', topic_name=topic.name, step_index=step_index - 1) }}"
                    class="button secondary" onclick="showLoader()">Previous Step</a>
                {% endif %}

                {% if step_index < total_steps - 1 %} <a
                    href="{{ url_for('chapter.learn_topic', topic_name=topic.name, step_index=step_index + 1) }}"
                    class="button" onclick="showLoader()">Next Step</a>
                    {% else %}
                    <a href="{{ url_for('chapter.complete_topic', topic_name=topic.name) }}" class="button"
                        onclick="showLoader()">Finish Course</a>
                    {% endif %}
            </div>
        </div>
    </div>
    <!-- Side Panel for Code Execution -->
    <div id="execution-side-panel" class="side-panel">
        <div class="resize-handle" id="resize-handle"></div>
        <div class="side-panel-header">
            <h3>Code Execution</h3>
            <button class="button secondary" onclick="closeSidePanel()">Close</button>
        </div>
        <div class="side-panel-content" id="side-panel-content">
            <p>Ready to execute code...</p>
        </div>
    </div>

    {% include 'common/chat_popup.html' %}
    {% endblock %}

    {% block scripts %}
    <script src="{{ url_for('chapter.static', filename='learn_step.js') }}"></script>
    <script src="{{ url_for('common.static', filename='js/time_tracker.js') }}"></script>
    <script src="{{ url_for('common.static', filename='js/chat_popup.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Time Tracker
            new TimeTracker({
                updateUrl: "{{ url_for('chapter.update_time', topic_name=topic.name, step_index=step_index) }}",
                topicName: "{{ topic.name }}"
            });

            initLearnStep({
                urls: {
                    execute_code: "{{ url_for('chapter.execute_code') }}",
                    generate_audio: "{{ url_for('chapter.generate_audio_route', step_index=step_index) }}",
                    generate_podcast: "{{ url_for('chapter.generate_podcast_route', topic_name=topic.name, step_index=step_index) }}"
                }
            });

            initChatPopup({
                urls: {
                    chat: "{{ url_for('chat.chat', topic_name=topic.name, step_index=step_index) }}"
                }
            });
        });
    </script>
    {% endblock %}
